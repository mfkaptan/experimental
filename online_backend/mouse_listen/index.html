<!DOCTYPE html>
<meta charset="UTF-8">
<head>
<title>JsClient</title>

</head>
<body>
    <script>
        /* Websocket */
        var sock = null;

        /* Default address */
        var wsuri = "ws://localhost:9000/";

        var mouse_x = 0, mouse_y = 0;

        function change_address()
        {
            var address = document.getElementById("wsuri");
            if(address.value.length != 0)
            {
                wsuri = address.value;
            }
            if (sock != null)
            {
                sock.close();
            }
            draw();
        }

        function draw()
        {
            if ("WebSocket" in window)
            {
                sock = new WebSocket(wsuri);
            }
            else
            {
                alert("Browser does not support WebSocket!");
            }

            var canvas = document.getElementById("canvas");
            var canvas2d = canvas.getContext("2d");
            var rect = canvas.getBoundingClientRect();

            // Event listener for mouse move
            canvas.addEventListener('mousemove', function(evt)
            {
                if(mouse_x != evt.clientX || mouse_y != evt.clientY )
                {
                    mouse_x = evt.clientX;
                    mouse_y = evt.clientY;
                    var message = JSON.stringify({x: mouse_x, y: mouse_y});
                    sock.send(message);
                }
            }, false);

            // Event listener for mouse down
            canvas.addEventListener('mousedown', function (evt)
            {
                var message = JSON.stringify({button: "down"});
                sock.send(message);
            })

            // Event listener for mouse up
            canvas.addEventListener('mouseup', function (evt)
            {
                var message = JSON.stringify({button: "up"});
                sock.send(message);
            })

            sock.onopen = function(evt)
            {
                document.getElementById("change").style.display = "none";
                document.getElementById("wsuri").style.display = "none";
                // Send first message
                sock.send("PNG");
            }

            sock.onclose = function(evt)
            {
                sock = null;
            }

            sock.onmessage = function(msg)
            {
                var message = JSON.parse(msg.data);

                var img = new Image();

                img.onload = function()
                {
                    // Draw the image to the canvas
                    canvas2d.drawImage(img, 0, 0);
                };

                img.src = "data:image/png;base64," + message.image;
                // Send this message so that server can understand client is ready
                sock.send("PNG");
            }
        }
    </script>

    <canvas id="canvas" width="512" height="512"></canvas>

    <input type="text" id="wsuri" placeholder="ws://localhost:9000/">
    <button id="change" onclick="change_address()">Connect</button>

    <noscript>You must enable JavaScript</noscript>
</body>
</html>
